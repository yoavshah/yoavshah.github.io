<!DOCTYPE html>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.125.3">

    

    

    
        
            <meta
                name="description"
                content="This is my new hugo site" />
        

        
            <meta
                name="keywords"
                content="security,cryptohack,writeups,cyber" />
        

        
            <meta
                name="author"
                content="yoavshah" />
        

    


    <title>
        
            oh-snap |
            SecurityBlog
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.912d03bce61461ecbc3ca083479e1ed814bba94df76d0bdc6aa88fdca33621b9bb410dc2c81af31e8101fec62decfa5f6e48901ad673bc5056d2f1d1f2368a34.css"
            integrity="sha512-kS0DvOYUYey8PKCDR54e2BS7qU33bQvcaqiP3KM2Ibm7QQ3CyBrzHoEB/sYt7PpfbkiQGtZzvFBW0vHR8jaKNA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            oh-snap -
            SecurityBlog
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Cryptohack </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> diffie-helman </span>

                    



    
    

    
    


    <ul class="section-tree">
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> symmetric </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/bean_counter/" title="./cryptohack/symmetric/bean_counter/">
                        
                            bean_counter
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/ctrime/" title="./cryptohack/symmetric/ctrime/">
                        
                            ctrime
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/dancing_queen/" title="./cryptohack/symmetric/dancing_queen/">
                        
                            dancing_queen
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/ecb_oracle/" title="./cryptohack/symmetric/ecb_oracle/">
                        
                            ecb_oracle
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/ecbcbcwtf/" title="./cryptohack/symmetric/ecbcbcwtf/">
                        
                            ecbcbcwtf
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/flipping_cookie/" title="./cryptohack/symmetric/flipping_cookie/">
                        
                            flipping_cookie
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/lazy_cbc/" title="./cryptohack/symmetric/lazy_cbc/">
                        
                            lazy_cbc
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/logon_zero/" title="./cryptohack/symmetric/logon_zero/">
                        
                            logon_zero
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/oh-snap/" title="./cryptohack/symmetric/oh-snap/">
                        
                            oh-snap
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/passwords_as_keys/" title="./cryptohack/symmetric/passwords_as_keys/">
                        
                            passwords_as_keys
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/stream_consciousness/" title="./cryptohack/symmetric/stream_consciousness/">
                        
                            stream_consciousness
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/symmetry/" title="./cryptohack/symmetric/symmetry/">
                        
                            symmetry
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/triple_des/" title="./cryptohack/symmetric/triple_des/">
                        
                            triple_des
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                oh-snap
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/yoavshah/"
                                class="cat-btn">
                                yoavshah
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.04.26"
                            >2024.04.26
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        9 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    
    




<a href="https://yoavshah.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://yoavshah.github.io/cryptohack/" class="bread-btn">
    

    
        Cryptohack
    
</a>




    /



<a href="https://yoavshah.github.io/cryptohack/symmetric/" class="bread-btn">
    

    
        symmetric
    
</a>




    /



<a href="https://yoavshah.github.io/cryptohack/symmetric/oh-snap/" class="bread-btn">
    

    
        
            oh-snap
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents"></nav>
        


        <div class="content">
            
                <h1 id="challenge">Challenge</h1>
<p>This challenge was quite hard.
In this challenge we get a little program that receives a ciphertext and a $nonce$, then creates a new ARC4 encryption class that its key is equal to the $nonce$ concat with the $flag$, and then decrypts the ciphertext with it.
We need using some magic to get the flag (which is part of the key).</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="from%20Crypto.Cipher%20import%20ARC4%0d%0a%0d%0a%0d%0aFLAG%20=%20?%0d%0a%0d%0a%0d%0a@chal.route%28%27/oh_snap/send_cmd/%3cciphertext%3e/%3cnonce%3e/%27%29%0d%0adef%20send_cmd%28ciphertext,%20nonce%29:%0d%0a%20%20%20%20if%20not%20ciphertext:%0d%0a%20%20%20%20%20%20%20%20return%20%7b%22error%22:%20%22You%20must%20specify%20a%20ciphertext%22%7d%0d%0a%20%20%20%20if%20not%20nonce:%0d%0a%20%20%20%20%20%20%20%20return%20%7b%22error%22:%20%22You%20must%20specify%20a%20nonce%22%7d%0d%0a%0d%0a%20%20%20%20ciphertext%20=%20bytes.fromhex%28ciphertext%29%0d%0a%20%20%20%20nonce%20=%20bytes.fromhex%28nonce%29%0d%0a%0d%0a%20%20%20%20cipher%20=%20ARC4.new%28nonce%20&#43;%20FLAG.encode%28%29%29%0d%0a%20%20%20%20cmd%20=%20cipher.decrypt%28ciphertext%29%0d%0a%20%20%20%20if%20cmd%20==%20b%22ping%22:%0d%0a%20%20%20%20%20%20%20%20return%20%7b%22msg%22:%20%22Pong!%22%7d%0d%0a%20%20%20%20else:%0d%0a%20%20%20%20%20%20%20%20return%20%7b%22error%22:%20f%22Unknown%20command:%20%7bcmd.hex%28%29%7d%22%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> ARC4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLAG <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">?</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@chal.route</span>(<span style="color:#e6db74">&#39;/oh_snap/send_cmd/&lt;ciphertext&gt;/&lt;nonce&gt;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_cmd</span>(ciphertext, nonce):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ciphertext:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;You must specify a ciphertext&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> nonce:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;You must specify a nonce&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(ciphertext)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#f92672">=</span> ARC4<span style="color:#f92672">.</span>new(nonce <span style="color:#f92672">+</span> FLAG<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    cmd <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(ciphertext)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> cmd <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ping&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;Pong!&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Unknown command: </span><span style="color:#e6db74">{</span>cmd<span style="color:#f92672">.</span>hex()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}</span></span></code></pre></div>
    
</div>
<h1 id="solution">Solution</h1>
<p>Before we start with solving this challenge we have to know <a href="https://en.wikipedia.org/wiki/RC4">how RC4 works</a>.</p>
<p>When I approached this challenge, I first went to the source code of pycryptodome and I <a href="https://github.com/Legrandin/pycryptodome/blob/master/src/ARC4.c">found this C code</a></p>
<p>RC4 uses a key to create a pseudo-random generator that for each byte in the plaintext it will be xored with the next generated byte. Because of that, the encryption and the decryption routines will be the same, because they will generate the same byte.</p>
<p>Because RC4 uses keys in size of 256 bytes or less, we can find the flag size by sending $nonce$ with increasing length until we get an error, this way I found out that sending $nonce$ in size of 222 bytes works fine, but sending $nonce$ in size of 223 bytes returns &ldquo;internal server error&rdquo;, so the flag length is 34 bytes ($256 - 222 = 34$).</p>
<p>In RC4 the algorithm first initializes a 256 length array called $&ldquo;state&rdquo;$ in a way that each index contains the index inside it, meaning $state[0] = 0, state[1] = 1, &hellip;$</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20%20for%28i=0;%20i%3c256;%20i&#43;&#43;%29%0d%0a%20%20%20%20%20%20%20%20rc4State-%3estate[i]=%28uint8_t%29i;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>        rc4State<span style="color:#f92672">-&gt;</span>state[i]<span style="color:#f92672">=</span>(<span style="color:#66d9ef">uint8_t</span>)i;</span></span></code></pre></div>
    
</div>
<p>The next step in the intialization progress is that it executes a for loop 256 times, each iteration it takes the current key byte, calculates $index2$, and then swaps the element at position $i$ with the element at position $index2$.</p>
<p>$$
index2 = K[i] + S[i] + index2
$$</p>
<p>$$
Swap(i, index2)
$$</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20%20index1=0;%0d%0a%20%20%20%20index2=0;%0d%0a%20%20%20%20for%28i=0;%20i%3c256;%20i&#43;&#43;%29%0d%0a%20%20%20%20%7b%0d%0a%20%20%20%20%20%20%20%20unsigned%20t;%0d%0a%20%20%20%20%20%20%20%20index2%20=%20%28%20%28unsigned%29key[index1]%20&#43;%20rc4State-%3estate[i]%20&#43;%20index2%29%20%25%20256;%0d%0a%20%20%20%20%20%20%20%20t%20=%20rc4State-%3estate[i];%0d%0a%20%20%20%20%20%20%20%20rc4State-%3estate[i]%20=%20rc4State-%3estate[index2];%0d%0a%20%20%20%20%20%20%20%20rc4State-%3estate[index2]%20=%20%28uint8_t%29t;%0d%0a%20%20%20%20%20%20%20%20index1%20=%20%28index1%20&#43;%201%29%20%25%20%28unsigned%29keylen;%0d%0a%20%20%20%20%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    index1<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    index2<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">unsigned</span> t;
</span></span><span style="display:flex;"><span>        index2 <span style="color:#f92672">=</span> ( (<span style="color:#66d9ef">unsigned</span>)key[index1] <span style="color:#f92672">+</span> rc4State<span style="color:#f92672">-&gt;</span>state[i] <span style="color:#f92672">+</span> index2) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> rc4State<span style="color:#f92672">-&gt;</span>state[i];
</span></span><span style="display:flex;"><span>        rc4State<span style="color:#f92672">-&gt;</span>state[i] <span style="color:#f92672">=</span> rc4State<span style="color:#f92672">-&gt;</span>state[index2];
</span></span><span style="display:flex;"><span>        rc4State<span style="color:#f92672">-&gt;</span>state[index2] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint8_t</span>)t;
</span></span><span style="display:flex;"><span>        index1 <span style="color:#f92672">=</span> (index1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> (<span style="color:#66d9ef">unsigned</span>)keylen;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
    
</div>
<p>Because we have control over the key in this challenge, we can control some of the bytes at the $state$.</p>
<p>Because of how RC4 is built, in the initialization procress - indexes that are lower than $i$ (Current iteration) are most likely to not change!</p>
<p>Let&rsquo;s say we have index $j$.
At first $j$ will be swapped with a value for sure when executing the $j$ iteration.
Now, $j$ will be swapped again if and only if at any iteration, $index2$ will be equals to $j$, remember that $index2$ has 256 possible values so now lets calculate the probabillity of the worst case.</p>
<p>In our hypothetical case, we want to check what is the probabillity that the first element ($j$ = 0) will not be changed at the other 255 iterations.</p>
<p>The probabillity that $index2$ will not be equals 0 at an iteration is $\frac{255}{256}$.
We have 255 iterations, so lets power this probabillity up by 255
$$
\left (\frac{255}{256}  \right )^{255} = 0.367&hellip;
$$</p>
<p>We can see it is a pretty high probabillity to not change, but not enough, however we have control in this challenge over most of the key, 222 bytes, we will make our odds better by that!
We have only 34 bytes of the key we can&rsquo;t control instead of 255 bytes, so the probabillity of our hypothetical case is</p>
<p>$$
\left (\frac{255}{256}  \right )^{34} = 0.875&hellip;
$$</p>
<p>Because we can control some of the bytes in the $state$ and we can use the probabillity to keep them in the same positions we set them earlier, we actually have partial statistical control over the $state$ after the initialization process!</p>
<p>Now let&rsquo;s have a look on the encryption routine</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="EXPORT_SYM%20int%20ARC4_stream_encrypt%28stream_state%20*rc4State,%20const%20uint8_t%20in[],%20uint8_t%20out[],%20size_t%20len%29%0d%0a%7b%0d%0a%20%20%20%20unsigned%20i;%0d%0a%20%20%20%20unsigned%20x=rc4State-%3ex,%20y=rc4State-%3ey;%0d%0a%0d%0a%20%20%20%20for%20%28i=0;%20i%3clen;%20i&#43;&#43;%29%0d%0a%20%20%20%20%7b%0d%0a%20%20%20%20%20%20%20%20x%20=%20%28x%20&#43;%201%29%20%25%20256;%0d%0a%20%20%20%20%20%20%20%20y%20=%20%28y%20&#43;%20rc4State-%3estate[x]%29%20%25%20256;%0d%0a%20%20%20%20%20%20%20%20%7b%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20unsigned%20t;%20%20%20%20%20%20/*%20Exchange%20state[x]%20and%20state[y]%20*/%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20t%20=%20rc4State-%3estate[x];%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20rc4State-%3estate[x]%20=%20rc4State-%3estate[y];%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20rc4State-%3estate[y]%20=%20%28uint8_t%29t;%0d%0a%20%20%20%20%20%20%20%20%7d%0d%0a%20%20%20%20%20%20%20%20%7b%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20unsigned%20xorIndex;%20%20%20/*%20XOR%20the%20data%20with%20the%20stream%20data%20*/%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20xorIndex=%28rc4State-%3estate[x]&#43;rc4State-%3estate[y]%29%20%25%20256;%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20out[i]%20=%20in[i]%20%5e%20rc4State-%3estate[xorIndex];%0d%0a%20%20%20%20%20%20%20%20%7d%0d%0a%20%20%20%20%7d%0d%0a%20%20%20%20rc4State-%3ex=%28uint8_t%29x;%0d%0a%20%20%20%20rc4State-%3ey=%28uint8_t%29y;%0d%0a%20%20%20%20return%200;%0d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>EXPORT_SYM <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ARC4_stream_encrypt</span>(stream_state <span style="color:#f92672">*</span>rc4State, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> in[], <span style="color:#66d9ef">uint8_t</span> out[], <span style="color:#66d9ef">size_t</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> x<span style="color:#f92672">=</span>rc4State<span style="color:#f92672">-&gt;</span>x, y<span style="color:#f92672">=</span>rc4State<span style="color:#f92672">-&gt;</span>y;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>len; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> (x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>        y <span style="color:#f92672">=</span> (y <span style="color:#f92672">+</span> rc4State<span style="color:#f92672">-&gt;</span>state[x]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> t;      <span style="color:#75715e">/* Exchange state[x] and state[y] */</span>
</span></span><span style="display:flex;"><span>            t <span style="color:#f92672">=</span> rc4State<span style="color:#f92672">-&gt;</span>state[x];
</span></span><span style="display:flex;"><span>            rc4State<span style="color:#f92672">-&gt;</span>state[x] <span style="color:#f92672">=</span> rc4State<span style="color:#f92672">-&gt;</span>state[y];
</span></span><span style="display:flex;"><span>            rc4State<span style="color:#f92672">-&gt;</span>state[y] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint8_t</span>)t;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> xorIndex;   <span style="color:#75715e">/* XOR the data with the stream data */</span>
</span></span><span style="display:flex;"><span>            xorIndex<span style="color:#f92672">=</span>(rc4State<span style="color:#f92672">-&gt;</span>state[x]<span style="color:#f92672">+</span>rc4State<span style="color:#f92672">-&gt;</span>state[y]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>            out[i] <span style="color:#f92672">=</span> in[i] <span style="color:#f92672">^</span> rc4State<span style="color:#f92672">-&gt;</span>state[xorIndex];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    rc4State<span style="color:#f92672">-&gt;</span>x<span style="color:#f92672">=</span>(<span style="color:#66d9ef">uint8_t</span>)x;
</span></span><span style="display:flex;"><span>    rc4State<span style="color:#f92672">-&gt;</span>y<span style="color:#f92672">=</span>(<span style="color:#66d9ef">uint8_t</span>)y;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p>We can see the input is an array of $len$ bytes and the output is the cipher, at the first byte it sets $x = 1$, then takes $y = S[x] = S[1]$, swaps $x$ with $y$ and then calculates $xorIndex = S[x] + S[y]$ and xors the value in this index with the input.
After the first byte it changes $x$ and $y$, thus making it more confusing.</p>
<p>We can control the $state$ as shown in the previous steps, can we use it to gain more information about it? YES</p>
<p>So let&rsquo;s set $S[1] = 0$, $S[0] = pos$
As we can see in the encryption routine we set $x = 1$, $y = S[x] = S[1] = 0$, and then calculate $xorIndex$</p>
<p>$$
xorIndex = S[x] + S[y] = 0 + S[0] = S[0] = pos
$$</p>
<p>Then if we send the value $0x00$ to encrypt it we will get $S[pos]$.
Great, we can now extract information about the $state$.</p>
<p>With this in mind, how can we use it to extract the flag?</p>
<p>Let&rsquo;s build a $nonce$ that will set $S[1] = 0$ and $S[0] = pos$ when $pos$ equals to the position of the first character in the flag, we know the flag size is 34, so the first character position is $pos = 222$.</p>
<p>We can now generate padding of 210 bytes that will not affect any bytes in the $state$, how do we do it? by calculating what the key should be in order to $index2$ to be equal to $i$ (and then it will swap with itself).</p>
<p>Then we add 10 randomized bytes (that do not affect position 0 and position 1).</p>
<p>We can run the initialization process and stop it in the middle, doing only 222 iterations (stopping before the iteration of $i = 222$), we can now get the $state$, let&rsquo;s call it $S_{old}$.</p>
<p>We know that $S_{old}[0] = 222$ and that $S_{old}[1] = 0$, we also know what is the value of $S_{old}[222]$ and $index2_{221}$ which is the $index2$ at the end of iteration 221.</p>
<p>Now let&rsquo;s execute the normal encryption in the remote program with the byte $0x00$. We know that statistically $S[0] = 222$ and $S[1] = 0$, so most of the time we will get $S[222]$ as an output.</p>
<p>We can find $S[222]$ in the old $state$, the position we found is most likely $index2_{222}$ which is $index2$ at the end of iteration 222!</p>
<p>We know that</p>
<p>$$
index2_{222} = index2_{221} + K[222] + S_{221}[222]
$$
So
$$
K[222] = index2_{222} - index2_{221} - S_{221}[222]
$$</p>
<p>We have access to $index2_{222}$, $index2_{221}$ and $S_{221}[222]$ so we can find $K[222]$ which is the flag first character!</p>
<p>Remember that we cannot be 100% sure that the byte we found is $K[222]$, we can only suspect it! o we will execute it multiple times to gain more assurance of our suspected byte.</p>
<p>We can later execute this algorithm for each of the bytes of the flag to find it all!</p>
<p>Note 1: We can also filter non printable suspected bytes.
Note 2: In the program we got the decryption method of RC4, but I called it the encryption method because it doesn&rsquo;t matter.
Note 3: I actually found out after solving this problem that there is an attack called <a href="https://en.wikipedia.org/wiki/Fluhrer,_Mantin_and_Shamir_attack">FMS</a> which is very similar
Note 4: You can make the solution work fast by executing the iterations with thread pool.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> ARC4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ascii_chars <span style="color:#f92672">=</span> [ord(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>printable]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_req</span>(cipher, nonce):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        SITE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://aes.cryptohack.org/oh_snap/send_cmd&#34;</span>
</span></span><span style="display:flex;"><span>        current_site <span style="color:#f92672">=</span>  <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>SITE<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>cipher<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>nonce<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> requests<span style="color:#f92672">.</span>get(current_site)<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;error&#34;</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;Unknown command: &#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(e)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>flag_location <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> flag_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>known_flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_state</span>():
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>        state<span style="color:#f92672">.</span>append(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">key_routine</span>(state, key, l<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>    index2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(l):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        index2 <span style="color:#f92672">=</span> (index2 <span style="color:#f92672">+</span> key[i <span style="color:#f92672">%</span> len(key)] <span style="color:#f92672">+</span> state[i]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> state[i]
</span></span><span style="display:flex;"><span>        state[i] <span style="color:#f92672">=</span> state[index2]
</span></span><span style="display:flex;"><span>        state[index2] <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> index2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">next_key_routine</span>(state, key, i, index2):
</span></span><span style="display:flex;"><span>    index2 <span style="color:#f92672">=</span> (index2 <span style="color:#f92672">+</span> key[i <span style="color:#f92672">%</span> len(key)] <span style="color:#f92672">+</span> state[i]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> state[i]
</span></span><span style="display:flex;"><span>    state[i] <span style="color:#f92672">=</span> state[index2]
</span></span><span style="display:flex;"><span>    state[index2] <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> index2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">enc</span>(state, cipher):
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> state[x]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> state[x]
</span></span><span style="display:flex;"><span>    state[x] <span style="color:#f92672">=</span> state[y]
</span></span><span style="display:flex;"><span>    state[y] <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    xorIndex <span style="color:#f92672">=</span> (state[x] <span style="color:#f92672">+</span> state[y]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cipher <span style="color:#f92672">^</span> state[xorIndex]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>change_amount <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>tests_amount <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(known_flag), flag_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    current_try <span style="color:#f92672">=</span> Counter()
</span></span><span style="display:flex;"><span>    current_printable <span style="color:#f92672">=</span> Counter()
</span></span><span style="display:flex;"><span>    curr_flag_pos <span style="color:#f92672">=</span> flag_location <span style="color:#f92672">+</span> i
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> range(tests_amount):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> curr_flag_pos<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>) <span style="color:#75715e"># Get position to the first</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xff</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Get 0 to the second</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        s <span style="color:#f92672">=</span> init_state()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        index2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        index2 <span style="color:#f92672">=</span> next_key_routine(s, key, <span style="color:#ae81ff">0</span>, index2)
</span></span><span style="display:flex;"><span>        index2 <span style="color:#f92672">=</span> next_key_routine(s, key, <span style="color:#ae81ff">1</span>, index2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># to make next index2 to be 2</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">+=</span> ((<span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (index2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>))<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>        index2 <span style="color:#f92672">=</span> next_key_routine(s, key, <span style="color:#ae81ff">2</span>, index2)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span>, flag_location <span style="color:#f92672">-</span> change_amount):
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">+=</span> ((<span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> j) <span style="color:#f92672">-</span> (index2 <span style="color:#f92672">+</span> j))<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>            index2 <span style="color:#f92672">=</span> next_key_routine(s, key, j, index2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(flag_location <span style="color:#f92672">-</span> change_amount, flag_location):
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># generate random current key that will not change index 0 or 1</span>
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">+=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>            index2 <span style="color:#f92672">=</span> next_key_routine(s, key, j, index2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># This is the current weak key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(flag_location, curr_flag_pos):
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">+=</span> known_flag<span style="color:#f92672">.</span>encode()[j <span style="color:#f92672">-</span> flag_location]<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>            index2 <span style="color:#f92672">=</span> next_key_routine(s, key, j, index2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        last_index2 <span style="color:#f92672">=</span> index2
</span></span><span style="display:flex;"><span>        last_state <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ok_state <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>        other_val_cipher <span style="color:#f92672">=</span> int(send_req(<span style="color:#e6db74">&#34;00&#34;</span>, key[:flag_location]<span style="color:#f92672">.</span>hex()), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find where the value position was before starting with the unknown keys, that might be the index2 of it</span>
</span></span><span style="display:flex;"><span>        other_index2 <span style="color:#f92672">=</span> last_state<span style="color:#f92672">.</span>index(other_val_cipher)
</span></span><span style="display:flex;"><span>                               
</span></span><span style="display:flex;"><span>        suspected_key <span style="color:#f92672">=</span> ((other_index2 <span style="color:#f92672">-</span> last_index2  <span style="color:#f92672">-</span> last_state[curr_flag_pos]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">256</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>)) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> suspected_key <span style="color:#f92672">in</span> ascii_chars:  
</span></span><span style="display:flex;"><span>            current_printable<span style="color:#f92672">.</span>update([suspected_key])
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    c <span style="color:#f92672">=</span> chr(current_printable<span style="color:#f92672">.</span>most_common()[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    known_flag <span style="color:#f92672">+=</span> c
</span></span><span style="display:flex;"><span>    print(known_flag)</span></span></code></pre></div>
    
</div>
<p><a href="/cryptohack/symmetric/code/oh-snap.py">oh-snap.py</a></p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>yoavshah</li>
            

            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1706
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.125.3</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Apr 26 2024 10:59:55
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
