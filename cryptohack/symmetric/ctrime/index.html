<!DOCTYPE html>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.125.3">

    

    

    
        
            <meta
                name="description"
                content="This is my new hugo site" />
        

        
            <meta
                name="keywords"
                content="security,cryptohack,writeups,cyber" />
        

        
            <meta
                name="author"
                content="yoavshah" />
        

    


    <title>
        
            ctrime |
            SecurityBlog
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.912d03bce61461ecbc3ca083479e1ed814bba94df76d0bdc6aa88fdca33621b9bb410dc2c81af31e8101fec62decfa5f6e48901ad673bc5056d2f1d1f2368a34.css"
            integrity="sha512-kS0DvOYUYey8PKCDR54e2BS7qU33bQvcaqiP3KM2Ibm7QQ3CyBrzHoEB/sYt7PpfbkiQGtZzvFBW0vHR8jaKNA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            ctrime -
            SecurityBlog
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Cryptohack </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> diffie-helman </span>

                    



    
    

    
    


    <ul class="section-tree">
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> symmetric </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/bean_counter/" title="./cryptohack/symmetric/bean_counter/">
                        
                            bean_counter
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/ctrime/" title="./cryptohack/symmetric/ctrime/">
                        
                            ctrime
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/dancing_queen/" title="./cryptohack/symmetric/dancing_queen/">
                        
                            dancing_queen
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/ecb_oracle/" title="./cryptohack/symmetric/ecb_oracle/">
                        
                            ecb_oracle
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/ecbcbcwtf/" title="./cryptohack/symmetric/ecbcbcwtf/">
                        
                            ecbcbcwtf
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/flipping_cookie/" title="./cryptohack/symmetric/flipping_cookie/">
                        
                            flipping_cookie
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/lazy_cbc/" title="./cryptohack/symmetric/lazy_cbc/">
                        
                            lazy_cbc
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/logon_zero/" title="./cryptohack/symmetric/logon_zero/">
                        
                            logon_zero
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/oh-snap/" title="./cryptohack/symmetric/oh-snap/">
                        
                            oh-snap
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/passwords_as_keys/" title="./cryptohack/symmetric/passwords_as_keys/">
                        
                            passwords_as_keys
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/stream_consciousness/" title="./cryptohack/symmetric/stream_consciousness/">
                        
                            stream_consciousness
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/symmetry/" title="./cryptohack/symmetric/symmetry/">
                        
                            symmetry
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://yoavshah.github.io/cryptohack/symmetric/triple_des/" title="./cryptohack/symmetric/triple_des/">
                        
                            triple_des
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                ctrime
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/yoavshah/"
                                class="cat-btn">
                                yoavshah
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.04.26"
                            >2024.04.26
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        3 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    
    




<a href="https://yoavshah.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://yoavshah.github.io/cryptohack/" class="bread-btn">
    

    
        Cryptohack
    
</a>




    /



<a href="https://yoavshah.github.io/cryptohack/symmetric/" class="bread-btn">
    

    
        symmetric
    
</a>




    /



<a href="https://yoavshah.github.io/cryptohack/symmetric/ctrime/" class="bread-btn">
    

    
        
            ctrime
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents"></nav>
        


        <div class="content">
            
                <h1 id="challenge">Challenge</h1>
<p>I really enjoyed this challenge.
In this challenge we get a program with the method encrypt which receives a plaintext, concat it with the flag, compress it with zlib and encrypt it with AES CTR mode (which is not actually a block cipher)
We need to get the flag.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="from%20Crypto.Cipher%20import%20AES%0d%0afrom%20Crypto.Util%20import%20Counter%0d%0aimport%20zlib%0d%0a%0d%0a%0d%0aKEY%20=%20?%0d%0aFLAG%20=%20?%0d%0a%0d%0a%0d%0a@chal.route%28%27/ctrime/encrypt/%3cplaintext%3e/%27%29%0d%0adef%20encrypt%28plaintext%29:%0d%0a%20%20%20%20plaintext%20=%20bytes.fromhex%28plaintext%29%0d%0a%0d%0a%20%20%20%20iv%20=%20int.from_bytes%28os.urandom%2816%29,%20%27big%27%29%0d%0a%20%20%20%20cipher%20=%20AES.new%28KEY,%20AES.MODE_CTR,%20counter=Counter.new%28128,%20initial_value=iv%29%29%0d%0a%20%20%20%20encrypted%20=%20cipher.encrypt%28zlib.compress%28plaintext%20&#43;%20FLAG.encode%28%29%29%29%0d%0a%0d%0a%20%20%20%20return%20%7b%22ciphertext%22:%20encrypted.hex%28%29%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> zlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>KEY <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">?</span>
</span></span><span style="display:flex;"><span>FLAG <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">?</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@chal.route</span>(<span style="color:#e6db74">&#39;/ctrime/encrypt/&lt;plaintext&gt;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(plaintext):
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(plaintext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    iv <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>), <span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(KEY, AES<span style="color:#f92672">.</span>MODE_CTR, counter<span style="color:#f92672">=</span>Counter<span style="color:#f92672">.</span>new(<span style="color:#ae81ff">128</span>, initial_value<span style="color:#f92672">=</span>iv))
</span></span><span style="display:flex;"><span>    encrypted <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>encrypt(zlib<span style="color:#f92672">.</span>compress(plaintext <span style="color:#f92672">+</span> FLAG<span style="color:#f92672">.</span>encode()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;ciphertext&#34;</span>: encrypted<span style="color:#f92672">.</span>hex()}</span></span></code></pre></div>
    
</div>
<p><img src="/cryptohack/symmetric/images/CTR_encryption.svg" alt="CTR Encryption"></p>
<h1 id="solution">Solution</h1>
<p>We can see that because CTR is not an actual block cipher it produces ciphertext without the need to pad it, so we can actually get the length of the plaintext.</p>
<p>In this challenge the program compresses the input with the flag, we can use the length of the encrypted data to gain information about the flag itself, and then bruteforce it byte after byte.</p>
<p>How do we do it?
zlib commpression finds sequence of bytes that are being repeated.</p>
<p>For example if we execute the following code</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="import%20zlib%0d%0alen%28zlib.compress%28b%22crypto%7bcrypto%7b1234567890%7d%22%29%29%0d%0alen%28zlib.compress%28b%22crypto%7b1crypto%7b1234567890%7d%22%29%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>import zlib
len(zlib.compress(b&#34;crypto{crypto{1234567890}&#34;))
len(zlib.compress(b&#34;crypto{1crypto{1234567890}&#34;))</code></pre>
    
</div>
<p>We can see that the length of both of the compressed data is the same, even though the uncompressed data length is not.
It happens because the substring &ldquo;crypto{1&rdquo; still appears in the text (as well as &ldquo;crypto{&rdquo; from the other compression).</p>
<p>But if we execute the next line</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="import%20zlib%0d%0alen%28zlib.compress%28b%22crypto%7b2crypto%7b1234567890%7d%22%29%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>import zlib
len(zlib.compress(b&#34;crypto{2crypto{1234567890}&#34;))</code></pre>
    
</div>
<p>the length actually increased, because the substring &ldquo;crypto{2&rdquo; does not appear again in the text.</p>
<p>So let&rsquo;s build an algorithm to find the $i$ byte.</p>
<p>First we will send the following input (its length is i, and we can set for the first round that the knownflag is &ldquo;crypto{&rdquo;)</p>
<p><code>[KNOWNFLAG]</code></p>
<p>Now we get an encrypted compressed data which is</p>
<p><code>ENC(COMPRESS([KNOWNFLAG] + [FLAG]))</code></p>
<p>where FLAG is our needed flag from the program.</p>
<p>We get the length of the encrypted data which is the length of the compressed knownflag and flag.</p>
<p>Now lets send another input</p>
<p><code>[KNOWNFLAG][BYTE]</code></p>
<p>Now we get an encrypted compressed data which is</p>
<p><code>ENC(COMPRESS([KNOWNFLAG] + [BYTE] + [FLAG]))</code></p>
<p>If the length of the second input equals the length of the first input, the byte we inserted in the second input is the next byte of the flag!</p>
<p>There are a few cases where the substring is too long and every character will increase the size of the compressed output by one, in those cases we just remove the first byte from the known flag.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> zlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SITE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://aes.cryptohack.org/ctrime/encrypt/</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLAG <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;crypto{&#34;</span>
</span></span><span style="display:flex;"><span>USED_FLAG <span style="color:#f92672">=</span> FLAG
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curr_plain <span style="color:#f92672">=</span> FLAG<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>lastlen <span style="color:#f92672">=</span> len(requests<span style="color:#f92672">.</span>get(SITE<span style="color:#f92672">.</span>format(curr_plain))<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;ciphertext&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Length of the compressed data &#34;</span> <span style="color:#f92672">+</span> str(lastlen))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lastc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> lastc <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;}&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    curr_plain <span style="color:#f92672">=</span> FLAG<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>printable<span style="color:#f92672">.</span>encode():
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        curr_text <span style="color:#f92672">=</span> padding<span style="color:#f92672">.</span>hex() <span style="color:#f92672">+</span> USED_FLAG<span style="color:#f92672">.</span>hex() <span style="color:#f92672">+</span> c<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> len(requests<span style="color:#f92672">.</span>get(SITE<span style="color:#f92672">.</span>format(curr_text))<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;ciphertext&#34;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> l <span style="color:#f92672">==</span> lastlen:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;found char &#34;</span> <span style="color:#f92672">+</span> chr(c))
</span></span><span style="display:flex;"><span>            lastc <span style="color:#f92672">=</span> chr(c)
</span></span><span style="display:flex;"><span>            FLAG <span style="color:#f92672">+=</span> c<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>            USED_FLAG <span style="color:#f92672">+=</span> c<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>            print(FLAG)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Could not find it, removing first data from flag&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        USED_FLAG <span style="color:#f92672">=</span> USED_FLAG[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        curr_text <span style="color:#f92672">=</span> USED_FLAG<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>        print(SITE<span style="color:#f92672">.</span>format(curr_text))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        lastlen <span style="color:#f92672">=</span> len(requests<span style="color:#f92672">.</span>get(SITE<span style="color:#f92672">.</span>format(curr_text))<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;ciphertext&#34;</span>])
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Found new length &#34;</span> <span style="color:#f92672">+</span> str(lastlen))</span></span></code></pre></div>
    
</div>
<p><a href="/cryptohack/symmetric/code/ctrime.py">ctrime.py</a></p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>yoavshah</li>
            

            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        524
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.125.3</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Apr 26 2024 10:59:55
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
